WITH STACKLINE_RETAILERS AS 
(SELECT DISTINCT * FROM
( SELECT RETAILERID,
         RETAILERSKU,
         WEEKID::VARCHAR AS WEEKID,
         LOADDTS,
         EVENTDTS,
         UPC

  FROM "PROD_RAW"."STACKLINE".SALES
  WHERE WEEKID >= 202201
UNION ALL
  SELECT RETAILERID,
         RETAILERSKU,
         WEEKID::VARCHAR AS WEEKID,
         LOADDTS,
         EVENTDTS,
         UPC
  FROM "PROD_RAW"."STACKLINE".RATINGSREVIEWS
  WHERE WEEKID >= 202201
  UNION ALL
  SELECT RETAILERID,
         RETAILERSKU,
         WEEKID::VARCHAR AS WEEKID,
         LOADDTS,
         EVENTDTS,
         UPC
  FROM "PROD_RAW"."STACKLINE".PROMOTIONS
  WHERE WEEKID >= 202201
  UNION ALL
  SELECT RETAILERID,
         RETAILERSKU,
         WEEKID::VARCHAR AS WEEKID,
         LOADDTS,
         EVENTDTS,
         UPC
  FROM "PROD_RAW"."STACKLINE".CONTENTSCORE
  WHERE WEEKID >= 202201
 )
)


SELECT 'STACKLINE' AS {{var('column_srcsyskey')}},
    md5(CONCAT(COALESCE(R.RETAILERID::VARCHAR,''),'~',COALESCE(R.RETAILERSKU::VARCHAR,''),'~',COALESCE(R.WEEKID::VARCHAR,''))) AS  {{var('column_rechashkey')}},
    R.LOADDTS AS       {{var('column_vereffdte')}},
    R.LOADDTS AS     {{var('column_SRC_RCRD_UPD_DTE')}},
    R.EVENTDTS AS      {{var('column_SRC_RCRD_CREATE_DTE')}},
    To_date('9999.12.31', 'YYYY.MM.DD') AS {{var('column_verexpirydt')}},
    {{var('default_y')}} as {{var('column_currrecflag')}},
    {{var('default_n')}} as {{var('column_orprecflag')}},
    {{var('default_n')}} as {{var('column_DEL_FROM_SRC_FLAG')}},
    '{{model.name}}'  AS {{var('column_ETL_INS_PID')}},
    CURRENT_TIMESTAMP::TIMESTAMP_NTZ  AS {{var('column_ETL_INS_DTE')}},
    '{{model.name}}'   AS {{var('column_ETL_UPD_PID')}},
    CURRENT_TIMESTAMP::TIMESTAMP_NTZ  AS {{var('column_ETL_UPD_DTE')}},
    CONCAT(COALESCE(R.RETAILERID::VARCHAR,''),'~',COALESCE(R.RETAILERSKU::VARCHAR,''),'~',COALESCE(R.WEEKID::VARCHAR,'')) AS PRC_COMPTTR_SLS_KEY,
    CONCAT(COALESCE(R.RETAILERID::VARCHAR,''),'~',COALESCE(R.RETAILERSKU::VARCHAR,'')) AS PROD_KEY, 
    R.UPC AS PROD_EAN,
    IFF( SUBSTR(SA.WEEKID, 5) = 1, TO_DATE( SUBSTR(SA.WEEKID, 1, 4), 'YYYY'), DATEADD( WEEK, SUBSTR(SA.WEEKID, 5)-2, DATEADD( DAY, 1, LAST_DAY(TO_DATE( SUBSTR(SA.WEEKID, 1, 4) , 'YYYY'), WEEK) )  )) as PRC_EFF_START_DTE, 
    DATEADD( day, 6, IFF( SUBSTR(SA.WEEKENDING, 5) = 1, TO_DATE( SUBSTR(SA.WEEKENDING, 1, 4), 'YYYY'), DATEADD( week, SUBSTR(SA.WEEKENDING, 5)-2, DATEADD( day, 1, LAST_DAY(TO_DATE( SUBSTR(SA.WEEKENDING, 1, 4) , 'YYYY'), week) )  )) ) AS PRC_EFF_END_DTE,
    COALESCE(SA.MODELNUMBER,P.MODELNUMBER,CS.MODELNUMBER,RR.MODELNUMBER) AS COMPTTR_PROD_NBR,
    COALESCE(SA.TITLE,P.TITLE,CS.TITLE,RR.TITLE) AS COMPTTR_PROD_DESC,
    COALESCE(SA.BRAND,P.BRAND,CS.BRAND,RR.BRAND) AS BRAND_NAME,
    P.PROMOTYPE AS SLS_PROMO_TYPE,
    P.DEALDATE AS SLS_PROMO_EVNT_START_DTE,
    NVL(COALESCE(SA.RETAILPRICE,P.RETAILPRICE),0) AS COMPTTR_PROD_PRC,
    COALESCE(SA.TITLE,P.TITLE,CS.TITLE,RR.TITLE) AS SBD_PROD_DESC,
    NVL(P.RETAILSALESCHANGE,0) AS RTL_SLS_CHNG,
    NVL(P.RETAILPRICECHANGE,0) AS RTL_PRC_CHNG,
    COALESCE(SA.RETAILERNAME,P.RETAILERNAME,CS.RETAILERNAME,RR.RETAILERNAME) as ONLINE_SELLER_NAME,
    COALESCE(SA.RETAILERSKU,P.RETAILERSKU,CS.RETAILERSKU,RR.RETAILERSKU) as ONLINE_PROD_CD,
    NVL(RR.RATING,0) AS RATING,
    NVL(RR.REVIEWSCOUNT,0) AS REVIEW_COUNT,
    NVL(COALESCE(SA.RETAILERID,P.RETAILERID,CS.RETAILERID,RR.RETAILERID),0) AS SELLER_ID,
    COALESCE(SA.RETAILERNAME,P.RETAILERNAME,CS.RETAILERNAME,RR.RETAILERNAME) as SELLER_NAME,
    COALESCE(SA.CATEGORY,P.CATEGORY,CS.CATEGORY,RR.CATEGORY) AS CTGY_NAME,
    COALESCE(SA.SUBCATEGORY,P.SUBCATEGORY,CS.SUBCATEGORY,RR.SUBCATEGORY) AS SUB_CTGY,
    NVL(COALESCE(SA.UNITSSOLD,P.UNITSSOLD),0) AS SOLD_QTY,
    NVL(COALESCE(SA.RETAILSALES,P.RETAILSALES,CS.RETAILSALES,RR.RETAILSALES),0) AS TOT_PRC,
    NVL(P.UNITSSOLDCHANGE,0) AS UNITS_SOLD_CHNG
    
FROM STACKLINE_RETAILERS AS R 
         LEFT OUTER JOIN "PROD_RAW"."STACKLINE".SALES SA
              ON  TRY_TO_NUMBER(R.RETAILERID) IS  NULL 
              AND TRY_TO_NUMBER(R.WEEKID) IS  NULL 
              AND TRY_TO_NUMBER(R.RETAILERSKU) IS  NULL
              AND R.RETAILERID = SA.RETAILERID
              AND R.RETAILERSKU = SA.RETAILERSKU
              AND R.WEEKID = SA.WEEKID
              AND R.LOADDTS = SA.LOADDTS
              AND R.EVENTDTS = SA.EVENTDTS
              AND R.UPC = SA.UPC

               
         LEFT OUTER JOIN "PROD_RAW"."STACKLINE".RATINGSREVIEWS RR
              ON  TRY_TO_NUMBER(R.RETAILERID) IS  NULL 
              AND TRY_TO_NUMBER(R.WEEKID) IS  NULL 
              AND TRY_TO_NUMBER(R.RETAILERSKU) IS  NULL
              AND R.RETAILERID = RR.RETAILERID
              AND R.RETAILERSKU = RR.RETAILERSKU
              AND R.WEEKID = RR.WEEKID
              AND R.LOADDTS = RR.LOADDTS
              AND R.EVENTDTS = RR.EVENTDTS
              AND R.UPC = RR.UPC

         LEFT OUTER JOIN "PROD_RAW"."STACKLINE".CONTENTSCORE CS
              ON TRY_TO_NUMBER(R.RETAILERID) IS  NULL 
              AND TRY_TO_NUMBER(R.WEEKID) IS  NULL 
              AND TRY_TO_NUMBER(R.RETAILERSKU) IS  NULL
              AND R.RETAILERID = CS.RETAILERID
              AND R.RETAILERSKU = CS.RETAILERSKU
              AND R.WEEKID = CS.WEEKID
              AND R.LOADDTS = CS.LOADDTS
              AND R.EVENTDTS = CS.EVENTDTS
              AND R.UPC = CS.UPC

         LEFT OUTER JOIN "PROD_RAW"."STACKLINE".PROMOTIONS P
              ON  TRY_TO_NUMBER(R.RETAILERID) IS  NULL 
              AND TRY_TO_NUMBER(R.RETAILERSKU) IS  NULL
              AND R.RETAILERID = P.RETAILERID
              AND R.RETAILERSKU = P.RETAILERSKU  
              AND R.LOADDTS = P.LOADDTS
              AND R.EVENTDTS = P.EVENTDTS
              AND R.UPC = P.UPC



STCAKLINE BALA'S MODIFIED STACKLINE:

WITH STACKLINE_RETAILERS AS 
( SELECT RETAILERID,
         RETAILERSKU,
         WEEKID
  FROM {{source('STACKLINE','SALES')}}
  WHERE WEEKID >= 202201
  UNION 
  SELECT RETAILERID,
         RETAILERSKU,
         WEEKID
  FROM {{source('STACKLINE','RATINGSREVIEWS')}}
  WHERE WEEKID >= 202201
  UNION 
  SELECT RETAILERID,
         RETAILERSKU,
         WEEKID
  FROM {{source('STACKLINE','PROMOTIONS')}}
  WHERE WEEKID >= 202201
  UNION
  SELECT RETAILERID,
         RETAILERSKU,
         WEEKID
  FROM {{source('STACKLINE','CONTENTSCORE')}}
  WHERE WEEKID >= 202201
)


SELECT 'STACKLINE' AS {{var('column_srcsyskey')}},
    md5(CONCAT(COALESCE(R.RETAILERSKU::VARCHAR,''),
           '~',COALESCE(R.RETAILERID::VARCHAR,''),
           '~',COALESCE(R.WEEKID::VARCHAR,''))) AS  {{var('column_rechashkey')}},
    LEAST(IFNULL(SA.LOADDTS,'2099-12-31'),IFNULL(P.LOADDTS,'2099-12-31'),IFNULL(CS.LOADDTS,'2099-12-31'),IFNULL(RR.LOADDTS,'2099-12-31')) AS       {{var('column_vereffdte')}},
    LEAST(IFNULL(SA.LOADDTS,'2099-12-31'),IFNULL(P.LOADDTS,'2099-12-31'),IFNULL(CS.LOADDTS,'2099-12-31'),IFNULL(RR.LOADDTS,'2099-12-31')) AS     {{var('column_SRC_RCRD_UPD_DTE')}},
    LEAST(IFNULL(SA.LOADDTS,'2099-12-31'),IFNULL(P.LOADDTS,'2099-12-31'),IFNULL(CS.LOADDTS,'2099-12-31'),IFNULL(RR.LOADDTS,'2099-12-31')) AS       {{var('column_z3loddtm')}},
    COALESCE(SA.EVENTDTS,P.EVENTDTS,CS.EVENTDTS,RR.EVENTDTS) AS      {{var('column_SRC_RCRD_CREATE_DTE')}},
    To_date('9999.12.31', 'YYYY.MM.DD') AS {{var('column_verexpirydt')}},
    {{var('default_y')}} as {{var('column_currrecflag')}},
    {{var('default_n')}} as {{var('column_orprecflag')}},
    {{var('default_n')}} as {{var('column_DEL_FROM_SRC_FLAG')}},
    '{{model.name}}'  AS {{var('column_ETL_INS_PID')}},
    CURRENT_TIMESTAMP::TIMESTAMP_NTZ  AS {{var('column_ETL_INS_DTE')}},
    '{{model.name}}'   AS {{var('column_ETL_UPD_PID')}},
    CURRENT_TIMESTAMP::TIMESTAMP_NTZ  AS {{var('column_ETL_UPD_DTE')}},
    (CONCAT(COALESCE(R.RETAILERSKU::VARCHAR,''),'~',COALESCE(R.RETAILERID::VARCHAR,''),'~',COALESCE(R.WEEKID::VARCHAR,'')))  AS PRC_COMPTTR_SLS_KEY,
    (CONCAT(COALESCE(R.RETAILERSKU::VARCHAR,''),'~',COALESCE(R.RETAILERID::VARCHAR,''))) AS PROD_KEY, 
    COALESCE(SA.UPC::VARCHAR,P.UPC::VARCHAR,CS.UPC::VARCHAR,RR.UPC::VARCHAR) AS PROD_EAN,
    IFF( SUBSTR(R.WEEKID, 5) = 1, TO_DATE( SUBSTR(R.WEEKID, 1, 4), 'YYYY'), DATEADD( WEEK, SUBSTR(R.WEEKID, 5)-2, DATEADD( DAY, 1, LAST_DAY(TO_DATE( SUBSTR(R.WEEKID, 1, 4) , 'YYYY'), WEEK) )  )) as PRC_EFF_START_DTE, 
    DATEADD( day, 6, IFF( SUBSTR(R.WEEKID, 5) = 1, TO_DATE( SUBSTR(R.WEEKID, 1, 4), 'YYYY'), DATEADD( WEEK, SUBSTR(R.WEEKID, 5)-2, DATEADD( DAY, 1, LAST_DAY(TO_DATE( SUBSTR(R.WEEKID, 1, 4) , 'YYYY'), WEEK) )  )) ) AS PRC_EFF_END_DTE,
    COALESCE(SA.MODELNUMBER::VARCHAR,P.MODELNUMBER::VARCHAR,CS.MODELNUMBER::VARCHAR,RR.MODELNUMBER::VARCHAR) AS COMPTTR_PROD_NBR,
    COALESCE(SA.TITLE::VARCHAR,P.TITLE::VARCHAR,CS.TITLE::VARCHAR,RR.TITLE::VARCHAR) AS COMPTTR_PROD_DESC,
    COALESCE(SA.BRAND::VARCHAR,P.BRAND::VARCHAR,CS.BRAND::VARCHAR,RR.BRAND::VARCHAR) AS BRAND_NAME,
    P.PROMOTYPE AS SLS_PROMO_TYPE,
    P.DEALDATE AS SLS_PROMO_EVNT_START_DTE,
    NVL(COALESCE(SA.RETAILPRICE,P.RETAILPRICE),0) AS COMPTTR_PROD_PRC,
    COALESCE(SA.TITLE::VARCHAR,P.TITLE::VARCHAR,CS.TITLE::VARCHAR,RR.TITLE::VARCHAR) AS SBD_PROD_DESC,
    NVL(P.RETAILSALESCHANGE,0) AS RTL_SLS_CHNG,
    NVL(P.RETAILPRICECHANGE,0) AS RTL_PRC_CHNG,
    COALESCE(SA.RETAILERNAME,P.RETAILERNAME,CS.RETAILERNAME,RR.RETAILERNAME) as ONLINE_SELLER_NAME,
    COALESCE(R.RETAILERSKU::VARCHAR,'-') as ONLINE_PROD_CD,
    NVL(RR.RATING,0) AS RATING,
    NVL(RR.REVIEWSCOUNT,0) AS REVIEW_COUNT,
    COALESCE(R.RETAILERID::VARCHAR,'-') AS SELLER_ID,
    COALESCE(SA.RETAILERNAME::VARCHAR,P.RETAILERNAME::VARCHAR,CS.RETAILERNAME::VARCHAR,RR.RETAILERNAME::VARCHAR) as SELLER_NAME,
    COALESCE(SA.CATEGORY::VARCHAR,P.CATEGORY::VARCHAR,CS.CATEGORY::VARCHAR,RR.CATEGORY::VARCHAR) AS CTGY_NAME,
    COALESCE(SA.SUBCATEGORY::VARCHAR,P.SUBCATEGORY::VARCHAR,CS.SUBCATEGORY::VARCHAR,RR.SUBCATEGORY::VARCHAR) AS SUB_CTGY,
    NVL(COALESCE(SA.UNITSSOLD,P.UNITSSOLD),0) AS SOLD_QTY,
    NVL(COALESCE(SA.RETAILSALES,P.RETAILSALES,CS.RETAILSALES,RR.RETAILSALES),0) AS TOT_PRC,
    NVL(P.UNITSSOLDCHANGE,0) AS UNITS_SOLD_CHNG
FROM STACKLINE_RETAILERS AS R 
  LEFT OUTER JOIN {{source('STACKLINE','SALES')}} SA
        ON R.RETAILERID = SA.RETAILERID
       AND R.RETAILERSKU = SA.RETAILERSKU
       AND R.WEEKID = SA.WEEKID
  LEFT OUTER JOIN {{source('STACKLINE','RATINGSREVIEWS')}} RR
        ON R.RETAILERID = RR.RETAILERID
       AND R.RETAILERSKU = RR.RETAILERSKU
       AND R.WEEKID = RR.WEEKID
  LEFT OUTER JOIN {{source('STACKLINE','CONTENTSCORE')}} CS
        ON R.RETAILERID = CS.RETAILERID
       AND R.RETAILERSKU = CS.RETAILERSKU
       AND R.WEEKID = CS.WEEKID
  LEFT OUTER JOIN {{source('STACKLINE','PROMOTIONS')}} P
        ON R.RETAILERID = P.RETAILERID
       AND R.RETAILERSKU = P.RETAILERSKU 

 


schema_config.yml
- name: STACKLINE
    schema: STACKLINE
    database: "{% if target.database == 'DEV_EDW' -%} DEV_RAW {% elif target.database == 'TEST_EDW' -%} TEST_RAW{% elif target.database == 'PROD_EDW' -%} PROD_RAW{% elif target.database == 'UAT_EDW' -%}UAT_RAW
                {% else -%} INVALID_DATABASE{% endif -%}"
    tables:
      - name: SALES
        identifier: SALES
      - name: PROMOTIONS
        identifier: PROMOTIONS
      - name: RATINGSREVIEWS
        identifier: RATINGSREVIEWS
      - name: CONTENTSCORE
        identifier: CONTENTSCORE
  
 