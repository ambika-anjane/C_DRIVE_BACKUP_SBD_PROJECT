SELECT 'STACKLINE' AS {{var('column_srcsyskey')}},
    md5(CONCAT(R.RETAILERSKU,R.RETAILERID,R.WEEKID::VARCHAR,'')) AS  {{var('column_rechashkey')}},
    COALESCE(SA.LOADDTS,P.LOADDTS,CS.LOADDTS,RR.LOADDTS) AS       {{var('column_vereffdte')}},
    COALESCE(SA.LOADDTS,P.LOADDTS,CS.LOADDTS,RR.LOADDTS) AS     {{var('column_SRC_RCRD_UPD_DTE')}},
    COALESCE(SA.EVENTDTS,P.EVENTDTS,CS.EVENTDTS,RR.EVENTDTS) AS      {{var('column_SRC_RCRD_CREATE_DTE')}},
    To_date('9999.12.31', 'YYYY.MM.DD') AS {{var('column_verexpirydt')}},
    {{var('default_y')}} as {{var('column_currrecflag')}},
    {{var('default_n')}} as {{var('column_orprecflag')}},
    {{var('default_n')}} as {{var('column_DEL_FROM_SRC_FLAG')}},
    '{{model.name}}'  AS {{var('column_ETL_INS_PID')}},
    CURRENT_TIMESTAMP::TIMESTAMP_NTZ  AS {{var('column_ETL_INS_DTE')}},
    '{{model.name}}'   AS {{var('column_ETL_UPD_PID')}},
    CURRENT_TIMESTAMP::TIMESTAMP_NTZ  AS {{var('column_ETL_UPD_DTE')}},
    (CONCAT(COALESCE(SA.RETAILERSKU,P.RETAILERSKU,CS.RETAILERSKU,RR.RETAILERSKU::VARCHAR,''),'~',COALESCE(SA.RETAILERID,P.RETAILERID,CS.RETAILERID,RR.RETAILERID::VARCHAR,''),'~',COALESCE(SA.WEEKID,P.WEEKID,CS.WEEKID,RR.WEEKID::VARCHAR,'')))  AS PRC_COMPTTR_SLS_KEY,
    (CONCAT(COALESCE(SA.RETAILERSKU,P.RETAILERSKU,CS.RETAILERSKU,RR.RETAILERSKU::VARCHAR,''),'~',COALESCE(SA.RETAILERID,P.RETAILERID,CS.RETAILERID,RR.RETAILERID::VARCHAR,''))) AS PROD_KEY, 
    COALESCE(SA.UPC,P.UPC,CS.UPC,RR.UPC) AS PROD_EAN,
    IFF( SUBSTR(SA.WEEKID, 5) = 1, TO_DATE( SUBSTR(SA.WEEKID, 1, 4), 'YYYY'), DATEADD( WEEK, SUBSTR(SA.WEEKID, 5)-2, DATEADD( DAY, 1, LAST_DAY(TO_DATE( SUBSTR(SA.WEEKID, 1, 4) , 'YYYY'), WEEK) )  )) as PRC_EFF_START_DTE, 
    DATEADD( day, 6, IFF( SUBSTR(SA.WEEKENDING, 5) = 1, TO_DATE( SUBSTR(SA.WEEKENDING, 1, 4), 'YYYY'), DATEADD( week, SUBSTR(SA.WEEKENDING, 5)-2, DATEADD( day, 1, LAST_DAY(TO_DATE( SUBSTR(SA.WEEKENDING, 1, 4) , 'YYYY'), week) )  )) ) AS PRC_EFF_END_DTE,
    COALESCE(SA.MODELNUMBER,P.MODELNUMBER,CS.MODELNUMBER,RR.MODELNUMBER) AS COMPTTR_PROD_NBR,
    COALESCE(SA.TITLE,P.TITLE,CS.TITLE,RR.TITLE) AS COMPTTR_PROD_DESC,
    COALESCE(SA.BRAND,P.BRAND,CS.BRAND,RR.BRAND) AS BRAND_NAME,
    P.PROMOTYPE AS SLS_PROMO_TYPE,
    P.DEALDATE AS SLS_PROMO_EVNT_START_DTE,
    COALESCE(SA.RETAILPRICE,P.RETAILPRICE) AS COMPTTR_PROD_PRC,
    COALESCE(SA.TITLE,P.TITLE,CS.TITLE,RR.TITLE) AS SBD_PROD_DESC,
    P.RETAILSALESCHANGE AS RTL_SLS_CHNG,
    P.RETAILPRICECHANGE AS RTL_PRC_CHNG,
    COALESCE(SA.RETAILERNAME,P.RETAILERNAME,CS.RETAILERNAME,RR.RETAILERNAME) as ONLINE_SELLER_NAME,
    COALESCE(SA.RETAILERSKU,P.RETAILERSKU,CS.RETAILERSKU,RR.RETAILERSKU) as ONLINE_PROD_CD,
    COALESCE(SA.RETAILSALES,P.RETAILSALES,CS.RETAILSALES,RR.RETAILSALES) AS TOT_PRC,
    RR.RATING AS RATING,
    RR.REVIEWSCOUNT AS REVIEW_COUNT,
    COALESCE(SA.RETAILERID,P.RETAILERID,CS.RETAILERID,RR.RETAILERID) AS SELLER_ID,
    COALESCE(SA.RETAILERNAME,P.RETAILERNAME,CS.RETAILERNAME,RR.RETAILERNAME) as SELLER_NAME,
    COALESCE(SA.CATEGORY,P.CATEGORY,CS.CATEGORY,RR.CATEGORY) AS CTGY_NAME,
    COALESCE(SA.SUBCATEGORY,P.SUBCATEGORY,CS.SUBCATEGORY,RR.SUBCATEGORY) AS SUB_CTGY,
    COALESCE(SA.UNITSSOLD,P.UNITSSOLD) AS SOLD_QTY,
    P.UNITSSOLDCHANGE AS UNITS_SOLD_CHNG



    NVL(SA.RETAILSALES,P.RETAILSALES,CS.RETAILSALES,RR.RETAILSALES,0) AS TOT_PRC,
