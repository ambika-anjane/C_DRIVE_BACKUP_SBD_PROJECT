WITH STACKLINE_RETAILERS AS 
(SELECT DISTINCT * FROM
( SELECT RETAILERID,
         RETAILERSKU,
         WEEKID::VARCHAR AS WEEKID
  FROM "PROD_RAW"."STACKLINE".SALES
  WHERE WEEKID >= 202201
UNION ALL
  SELECT RETAILERID,
         RETAILERSKU,
         WEEKID::VARCHAR AS WEEKID
  FROM "PROD_RAW"."STACKLINE".RATINGSREVIEWS
  WHERE WEEKID >= 202201
  UNION ALL
  SELECT RETAILERID,
         RETAILERSKU,
         WEEKID::VARCHAR AS WEEKID
  FROM "PROD_RAW"."STACKLINE".PROMOTIONS
  WHERE WEEKID >= 202201
  UNION ALL
SELECT RETAILERID,
         RETAILERSKU,
         WEEKID::VARCHAR AS WEEKID
  FROM "PROD_RAW"."STACKLINE".PROMOTIONS
  WHERE WEEKID >= 202201
  UNION ALL
  SELECT RETAILERID,
         RETAILERSKU,
         WEEKID::VARCHAR AS WEEKID
  FROM "PROD_RAW"."STACKLINE".CONTENTSCORE
  WHERE WEEKID >= 202201
 )






 
)


SELECT 'STACKLINE' AS {{var('column_srcsyskey')}},
    md5(CONCAT(COALESCE(R.RETAILERID::VARCHAR,''),'~',COALESCE(R.RETAILERSKU::VARCHAR,''),'~',COALESCE(R.WEEKID::VARCHAR,''))) AS  {{var('column_rechashkey')}},
    COALESCE(SA.LOADDTS,P.LOADDTS,CS.LOADDTS,RR.LOADDTS) AS       {{var('column_vereffdte')}},
    COALESCE(SA.LOADDTS,P.LOADDTS,CS.LOADDTS,RR.LOADDTS) AS     {{var('column_SRC_RCRD_UPD_DTE')}},
    COALESCE(SA.EVENTDTS,P.EVENTDTS,CS.EVENTDTS,RR.EVENTDTS) AS      {{var('column_SRC_RCRD_CREATE_DTE')}},
    To_date('9999.12.31', 'YYYY.MM.DD') AS {{var('column_verexpirydt')}},
    {{var('default_y')}} as {{var('column_currrecflag')}},
    {{var('default_n')}} as {{var('column_orprecflag')}},
    {{var('default_n')}} as {{var('column_DEL_FROM_SRC_FLAG')}},
    '{{model.name}}'  AS {{var('column_ETL_INS_PID')}},
    CURRENT_TIMESTAMP::TIMESTAMP_NTZ  AS {{var('column_ETL_INS_DTE')}},
    '{{model.name}}'   AS {{var('column_ETL_UPD_PID')}},
    CURRENT_TIMESTAMP::TIMESTAMP_NTZ  AS {{var('column_ETL_UPD_DTE')}},
    CONCAT(COALESCE(R.RETAILERID::VARCHAR,''),'~',COALESCE(R.RETAILERSKU::VARCHAR,''),'~',COALESCE(R.WEEKID::VARCHAR,'')) AS PRC_COMPTTR_SLS_KEY,
    CONCAT(COALESCE(R.RETAILERID::VARCHAR,''),'~',COALESCE(R.RETAILERSKU::VARCHAR,'')) AS PROD_KEY, 
    COALESCE(SA.UPC,P.UPC,CS.UPC,RR.UPC) AS PROD_EAN,
    IFF( SUBSTR(SA.WEEKID, 5) = 1, TO_DATE( SUBSTR(SA.WEEKID, 1, 4), 'YYYY'), DATEADD( WEEK, SUBSTR(SA.WEEKID, 5)-2, DATEADD( DAY, 1, LAST_DAY(TO_DATE( SUBSTR(SA.WEEKID, 1, 4) , 'YYYY'), WEEK) )  )) as PRC_EFF_START_DTE, 
    DATEADD( day, 6, IFF( SUBSTR(SA.WEEKENDING, 5) = 1, TO_DATE( SUBSTR(SA.WEEKENDING, 1, 4), 'YYYY'), DATEADD( week, SUBSTR(SA.WEEKENDING, 5)-2, DATEADD( day, 1, LAST_DAY(TO_DATE( SUBSTR(SA.WEEKENDING, 1, 4) , 'YYYY'), week) )  )) ) AS PRC_EFF_END_DTE,
    COALESCE(SA.MODELNUMBER,P.MODELNUMBER,CS.MODELNUMBER,RR.MODELNUMBER) AS COMPTTR_PROD_NBR,
    COALESCE(SA.TITLE,P.TITLE,CS.TITLE,RR.TITLE) AS COMPTTR_PROD_DESC,
    COALESCE(SA.BRAND,P.BRAND,CS.BRAND,RR.BRAND) AS BRAND_NAME,
    P.PROMOTYPE AS SLS_PROMO_TYPE,
    P.DEALDATE AS SLS_PROMO_EVNT_START_DTE,
    NVL(COALESCE(SA.RETAILPRICE,P.RETAILPRICE),0) AS COMPTTR_PROD_PRC,
    COALESCE(SA.TITLE,P.TITLE,CS.TITLE,RR.TITLE) AS SBD_PROD_DESC,
    NVL(P.RETAILSALESCHANGE,0) AS RTL_SLS_CHNG,
    NVL(P.RETAILPRICECHANGE,0) AS RTL_PRC_CHNG,
    COALESCE(SA.RETAILERNAME,P.RETAILERNAME,CS.RETAILERNAME,RR.RETAILERNAME) as ONLINE_SELLER_NAME,
    COALESCE(SA.RETAILERSKU,P.RETAILERSKU,CS.RETAILERSKU,RR.RETAILERSKU) as ONLINE_PROD_CD,
    NVL(RR.RATING,0) AS RATING,
    NVL(RR.REVIEWSCOUNT,0) AS REVIEW_COUNT,
    NVL(COALESCE(SA.RETAILERID,P.RETAILERID,CS.RETAILERID,RR.RETAILERID),0) AS SELLER_ID,
    COALESCE(SA.RETAILERNAME,P.RETAILERNAME,CS.RETAILERNAME,RR.RETAILERNAME) as SELLER_NAME,
    COALESCE(SA.CATEGORY,P.CATEGORY,CS.CATEGORY,RR.CATEGORY) AS CTGY_NAME,
    COALESCE(SA.SUBCATEGORY,P.SUBCATEGORY,CS.SUBCATEGORY,RR.SUBCATEGORY) AS SUB_CTGY,
    NVL(COALESCE(SA.UNITSSOLD,P.UNITSSOLD),0) AS SOLD_QTY,
    NVL(COALESCE(SA.RETAILSALES,P.RETAILSALES,CS.RETAILSALES,RR.RETAILSALES),0) AS TOT_PRC,
    NVL(P.UNITSSOLDCHANGE,0) AS UNITS_SOLD_CHNG
    
FROM STACKLINE_RETAILERS AS R 
         LEFT OUTER JOIN "PROD_RAW"."STACKLINE".SALES SA
              ON  TRY_TO_NUMBER(R.RETAILERID) IS  NULL 
              AND TRY_TO_NUMBER(R.WEEKID) IS  NULL 
              AND TRY_TO_NUMBER(R.RETAILERSKU) IS  NULL
              AND R.RETAILERID = SA.RETAILERID
              AND R.RETAILERSKU = SA.RETAILERSKU
              AND R.WEEKID = SA.WEEKID
               
         LEFT OUTER JOIN "PROD_RAW"."STACKLINE".RATINGSREVIEWS RR
              ON  TRY_TO_NUMBER(R.RETAILERID) IS  NULL 
              AND TRY_TO_NUMBER(R.WEEKID) IS  NULL 
              AND TRY_TO_NUMBER(R.RETAILERSKU) IS  NULL
              AND R.RETAILERID = RR.RETAILERID
              AND R.RETAILERSKU = RR.RETAILERSKU
              AND R.WEEKID = RR.WEEKID
         LEFT OUTER JOIN "PROD_RAW"."STACKLINE".CONTENTSCORE CS
              ON TRY_TO_NUMBER(R.RETAILERID) IS  NULL 
              AND TRY_TO_NUMBER(R.WEEKID) IS  NULL 
              AND TRY_TO_NUMBER(R.RETAILERSKU) IS  NULL
              AND R.RETAILERID = CS.RETAILERID
              AND R.RETAILERSKU = CS.RETAILERSKU
              AND R.WEEKID = CS.WEEKID
         LEFT OUTER JOIN "PROD_RAW"."STACKLINE".PROMOTIONS P
              ON  TRY_TO_NUMBER(R.RETAILERID) IS  NULL 
              AND TRY_TO_NUMBER(R.RETAILERSKU) IS  NULL
              AND R.RETAILERID = P.RETAILERID
              AND R.RETAILERSKU = P.RETAILERSKU  


RR:
              AND R.PROMOTYPE = RR.PROMOTYPE
              AND R.DEALDATE = RR.DEALDATE
              AND R.RETAILPRICE = RR.RETAILPRICE
              AND R.TITLE = RR.TITLE
              AND R.RETAILPRICECHANGE = RR.RETAILPRICECHANGE
              AND R.RETAILSALESCHANGE = RR.RETAILSALESCHANGE
              AND R.RETAILERNAME = RR.RETAILERNAME
              AND R.RETAILERSKU = RR.RETAILERSKU
              AND R.RATING = RR.RATING
              AND R.REVIEWSCOUNT = RR.REVIEWSCOUNT
              AND R.RETAILERID = RR.RETAILERID
              AND R.RETAILERNAME = RR.RETAILERNAME
              AND R.CATEGORY= RR.CATEGORY
              AND R.SUBCATEGORY= RR.SUBCATEGORY
              AND R.UNITSSOLD = RR.UNITSSOLD
              AND R.RETAILSALES = RR.RETAILSALES
              AND R.UNITSSOLDCHANGE = RR.UNITSSOLDCHANGE

CONTENTSCORE:
AND R.PROMOTYPE = CS.PROMOTYPE
              AND R.DEALDATE = CS.DEALDATE
              AND R.RETAILPRICE = CS.RETAILPRICE
              AND R.TITLE = CS.TITLE
              AND R.RETAILPRICECHANGE = CS.RETAILPRICECHANGE
              AND R.RETAILSALESCHANGE = CS.RETAILSALESCHANGE
              AND R.RETAILERNAME = CS.RETAILERNAME
              AND R.RETAILERSKU = CS.RETAILERSKU
              AND R.RATING = CS.RATING
              AND R.REVIEWSCOUNT = CS.REVIEWSCOUNT
              AND R.RETAILERID = CS.RETAILERID
              AND R.RETAILERNAME = CS.RETAILERNAME
              AND R.CATEGORY= CS.CATEGORY
              AND R.SUBCATEGORY= CS.SUBCATEGORY
              AND R.UNITSSOLD = CS.UNITSSOLD
              AND R.RETAILSALES = CS.RETAILSALES
              AND R.UNITSSOLDCHANGE = CS.UNITSSOLDCHANGE


PROMOTIONS:
AND R.PROMOTYPE = P.PROMOTYPE
              AND R.DEALDATE = P.DEALDATE
              AND R.RETAILPRICE = P.RETAILPRICE
              AND R.TITLE = P.TITLE
              AND R.RETAILPRICECHANGE = P.RETAILPRICECHANGE
              AND R.RETAILSALESCHANGE = P.RETAILSALESCHANGE
              AND R.RETAILERNAME = P.RETAILERNAME
              AND R.RETAILERSKU = P.RETAILERSKU
              AND R.RATING = P.RATING
              AND R.REVIEWSCOUNT =P.REVIEWSCOUNT
              AND R.RETAILERID = P.RETAILERID
              AND R.RETAILERNAME = P.RETAILERNAME
              AND R.CATEGORY= P.CATEGORY
              AND R.SUBCATEGORY= P.SUBCATEGORY
              AND R.UNITSSOLD = P.UNITSSOLD
              AND R.RETAILSALES = P.RETAILSALES
              AND R.UNITSSOLDCHANGE = P.UNITSSOLDCHANGE


              




 